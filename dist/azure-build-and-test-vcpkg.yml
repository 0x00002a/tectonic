# Copyright 2016-2020 the Tectonic Project
# Licensed under the MIT License.
#
# Azure Pipelines template for a standard build-and-test job getting
# dependencies through vcpkg. Besides the parameters, the following variables
# are expected:
#
# - TARGET: the build target triple (e.g. "x86_86-unknown-linux-gnu")
# - TOOLCHAIN: the rust toolchain type (e.g., "stable",
#   "beta-x86_64-pc-windows-msvc")

parameters:
- name: canaryBuild
  type: boolean
  default: false
- name: primaryRcBuild
  type: boolean
  default: false

steps:
- template: azure-generic-build-setup.yml

- script: |
    git clone https://github.com/Microsoft/vcpkg %USERPROFILE%\vcpkg
    call %USERPROFILE%\vcpkg\bootstrap-vcpkg.bat
    %USERPROFILE%\vcpkg\vcpkg install --triplet x64-windows-static fontconfig freetype harfbuzz[icu,graphite2]
    echo ##vso[task.setvariable variable=VCPKG_ROOT;]%USERPROFILE%\vcpkg
    echo ##vso[task.setvariable variable=TECTONIC_DEP_BACKEND;]vcpkg
    echo ##vso[task.setvariable variable=RUSTFLAGS;]-Ctarget-feature=+crt-static
  displayName: "Setup vcpkg (Windows MSVC)"
  condition: and(succeeded(), endsWith(variables['TARGET'], '-msvc'))

- bash: |
    set -xeuo pipefail
    brew install gcc pkg-config
  displayName: "Install vcpkg dependencies (macOS)"
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

- script: |
    set -xeuo pipefail
    git clone https://github.com/Microsoft/vcpkg.git
    export CC=gcc-9 CXX=g++-9
    ./vcpkg/bootstrap-vcpkg.sh --disableMetrics
    ./vcpkg/vcpkg install freetype 'harfbuzz[icu,graphite2]'
    echo "##vso[task.setvariable variable=VCPKG_ROOT;]$(pwd)/vcpkg"
    echo "##vso[task.setvariable variable=TECTONIC_DEP_BACKEND;]vcpkg"
  displayName: "Setup vcpkg (not Windows)"
  condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))

- template: azure-generic-build.yml
  parameters:
    canaryBuild: ${{ parameters.canaryBuild }}
    primaryRcBuild: ${{ parameters.primaryRcBuild }}
